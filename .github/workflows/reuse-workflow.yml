name: Reusing Worfklow
on:
  workflow_dispatch:
jobs:
  call_workflow:

    uses: ./.github/workflows/analyze_and_out.yml
    secrets:
      token: ${{secrets.API_TOKEN_GH}}

  show_output:
    needs: call_workflow
    runs-on: ubuntu-latest
    steps:
      - name: show it
        run: echo ${{needs.call_workflow.outputs.dependencies}} 
        
  run-and-test:
    runs-on: ubuntu-latest
    needs: call_workflow
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{needs.call_workflow.outputs.branch_created}}

      - name: Set up Docker Compose
        uses: docker/setup-compose-action@v1

      - name: Pull JDK
        run: docker pull openjdk:17-jdk-slim
        
      - uses: grafana/setup-k6-action@v1

      - name: Set up Git
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          
      - name: Show build.gradle (library)
        working-directory: library-example
        run: cat build.gradle

      - name: Build Application
        run: ./gradlew build

      - name: Run docker compose with logs
        working-directory: ms-example-usage
        run: |
          docker build -t my-app .
          docker run --network host -p 8080:8080 --name my-app my-app &
          
      - name: Run Grafana k6 tests
        uses: grafana/run-k6-action@v1.2.0
        with:
          path: |
            ./ms-example-usage/k6-tests*.js 

      - name: Archive K6 Test Reports
        uses: actions/upload-artifact@v4
        with:
          name: k6-results
          path: ./index.html
          retention-days: 1

      - name: Create Security Patch Issue
        env:
          DEPS: ${{ needs.call_workflow.outputs.dependencies }}
          BRANCH_NAME: ${{ needs.call_workflow.outputs.branch_created }}
        run: |
          IFS=',' read -ra deps_array <<< "$DEPS"
      
          formatted_changes=""
          for dep in "${deps_array[@]}"; do
            GROUP=$(echo "$dep" | cut -d':' -f1)
            ARTIFACT=$(echo "$dep" | cut -d':' -f2)
            VERSION=$(echo "$dep" | cut -d':' -f3)
            formatted_changes+="- â¬†ï¸ Updated \`${GROUP}:${ARTIFACT}\` to \`${VERSION}\`%0A"
          done
      
          body="## ðŸ›¡ï¸ Summary%0A%0A"
          body+="This issue documents the resolution of security vulnerabilities identified in recent dependency scans.%0A%0A"
          body+="## ðŸ”§ Changes Made%0A%0A"
          body+="${formatted_changes}"
          body+="- ðŸ” Regenerated \`lock\` file to ensure nested dependencies are up-to-date%0A%0A"
          body+="## ðŸ“š References%0A%0A"
          body+="- ðŸ“Œ Dependabot Alerts%0A"
          body+="- ðŸ§¾ Internal Security Audit%0A"
          body+="- ðŸ•µï¸â€â™‚ï¸ CVE Database (if applicable)%0A%0A"
          body+="## âœ… Next Steps%0A%0A"
          body+="- [ ] ðŸ” Verify test suite on staging%0A"
          body+="- [ ] ðŸ“¦ Monitor deployments for any issues%0A"
          body+="- [ ] ðŸ” Coordinate with security team for final review%0A%0A"
          body+="#3 pr%0A%0A"
          body+="ðŸ”— Branch with the fix: [${BRANCH_NAME}](https://github.com/testing-organization/library-mono-repo/tree/${BRANCH_NAME})"
      
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/testing-organization-jcayllahua/library-mono-repo/issues \
            -f "title=ðŸ” Security Fixes: Test Failed after patching vulnerabilities" \
            -f "body=${body}" \
            -f "labels[]=security-patch"
            -f "type=Security"
            
      - name: Deploy
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
